#!/bin/bash

DIR=$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )

set -e

COLOR_DIR="\033[1;36m"
COLOR_BRANCH="\033[1;32m"
COLOR_RESET="\033[0m"

update_path ()
{
    local target="$1"

    if [ ! -d "$target" ]; then
        return
    fi

    pushd "$target" >/dev/null
    update_repo
    popd >/dev/null
}

choose_branch ()
{
    local branch
    for branch in main master develop; do
        if git show-ref --verify --quiet "refs/heads/$branch"; then
            echo "$branch"
            return 0
        fi

        if git show-ref --verify --quiet "refs/remotes/origin/$branch"; then
            echo "$branch"
            return 0
        fi
    done

    branch=$(git symbolic-ref --short HEAD 2>/dev/null || true)
    if [ -n "$branch" ] && [ "$branch" != "HEAD" ]; then
        echo "$branch"
        return 0
    fi

    branch=$(git symbolic-ref --short refs/remotes/origin/HEAD 2>/dev/null || true)
    if [ -n "$branch" ]; then
        echo "$branch"
        return 0
    fi

    return 1
}

checkout_branch ()
{
    local branch="$1"

    if git show-ref --verify --quiet "refs/heads/$branch"; then
        git checkout "$branch"
        return 0
    fi

    if git show-ref --verify --quiet "refs/remotes/origin/$branch"; then
        git checkout -B "$branch" "origin/$branch"
        return 0
    fi

    echo "Unable to find branch $branch" >&2
    return 1
}

update_repo ()
{
    if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
        return
    fi

    local branch repo_dir

    branch=$(choose_branch) || return
    repo_dir=$(pwd)

    printf "%b%s%b %b%s%b\n" "$COLOR_DIR" "$repo_dir" "$COLOR_RESET" "$COLOR_BRANCH" "$branch" "$COLOR_RESET"

    checkout_branch "$branch"
    git pull

    if git remote | grep -qx upstream; then
        git pull upstream "$branch"
    fi
}

plugins_dir="$DIR/../.tmux/plugins"
if [ -d "$plugins_dir" ]; then
    for dir in "$plugins_dir"/*; do
        [ -d "$dir" ] || continue
        update_path "$dir"
    done
fi

update_path "$HOME/dot/fisher/"
update_path "$HOME/dot/src/bash-z"
update_path "$HOME/dot/src/dircolors-solarized"
update_path "$HOME/dot/src/selenized"
update_path "$HOME/dot/src/tmux-gruvbox"
update_path "$HOME/dot/src/dtach"
